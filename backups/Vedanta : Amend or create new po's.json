{
  "active": true,
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Get url and token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get url and token": {
      "main": [
        [
          {
            "node": "Get the vendor po",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get the vendor po": {
      "main": [
        [
          {
            "node": "Get the po items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get the po items": {
      "main": [
        [
          {
            "node": "Get all vendor pos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get the amended vendor po": {
      "main": [
        [
          {
            "node": "Get the amended po items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get the amended po items": {
      "main": [
        [
          {
            "node": "Get the latest vendor po",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get the latest vendor po": {
      "main": [
        [
          {
            "node": "Function to amend po",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get all vendor pos": {
      "main": [
        [
          {
            "node": "Get the amended vendor po",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function to amend po": {
      "main": [
        [
          {
            "node": "Check for delivery update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check for delivery update": {
      "main": [
        [
          {
            "node": "Udpate delivery dates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Udpate delivery dates": {
      "main": [
        [
          {
            "node": "Udpate vedanta delivery date",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2024-01-08T12:57:49.875Z",
  "id": "396",
  "name": "Vedanta : Amend or create new po's",
  "nodes": [
    {
      "parameters": {},
      "name": "Start",
      "type": "n8n-nodes-base.start",
      "typeVersion": 1,
      "position": [
        60,
        320
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "=amend-po",
        "options": {}
      },
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        280,
        320
      ],
      "webhookId": "3b46a90e-2b22-4918-bb86-cda5b3bf38c1"
    },
    {
      "parameters": {
        "authentication": "basicAuth",
        "requestMethod": "POST",
        "url": "=https://qan8n.shakedeal.com/webhook/get-url",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "client",
              "value": "=vedanta"
            },
            {
              "name": "env",
              "value": "=qa"
            }
          ]
        }
      },
      "name": "Get url and token",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        480,
        320
      ],
      "credentials": {
        "httpBasicAuth": {
          "id": "2",
          "name": "SD Basic Auth"
        }
      }
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "={{$node[\"Get url and token\"].json[\"0\"][\"mozart_url\"]}}/items/sdm_vendor_pos?filter={\"id\":{\"_eq\":\"{{$node[\"Webhook\"].json[\"body\"][\"keys\"][0]}}\"}}&fields=*,po_num.*",
        "options": {}
      },
      "name": "Get the vendor po",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        680,
        320
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "50",
          "name": "Mozart DMS Token"
        }
      }
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "={{$node[\"Get url and token\"].json[\"0\"][\"mozart_url\"]}}/items/sdm_po_items?filter={\"vendor_po\":{\"_eq\":\"{{$node[\"Webhook\"].json[\"body\"][\"keys\"][0]}}\"}}&limit=-1&fields=id,net_price,gross_price,delivery_date,vendor_po,unit_price,tax_percentage,uom,plant,vendor,hsn,requested_qty,product",
        "options": {}
      },
      "name": "Get the po items",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        880,
        320
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "50",
          "name": "Mozart DMS Token"
        }
      }
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "={{$node[\"Get url and token\"].json[\"0\"][\"mozart_url\"]}}/items/sdm_vendor_pos_ammend?filter={\"id\":{\"_eq\":\"{{$node[\"Webhook\"].json[\"body\"][\"keys\"][0]}}\"}}",
        "options": {}
      },
      "name": "Get the amended vendor po",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1200,
        320
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "50",
          "name": "Mozart DMS Token"
        }
      }
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "={{$node[\"Get url and token\"].json[\"0\"][\"mozart_url\"]}}/items/sdm_vendor_po_items_ammend?filter={\"vendor_po\":{\"_eq\":\"{{$node[\"Webhook\"].json[\"body\"][\"keys\"][0]}}\"}}&limit=-1&fields=id,net_price,gross_price,delivery_date,vendor_po,unit_price,tax_percentage,uom,plant,vendor,hsn,requested_qty,product",
        "options": {}
      },
      "name": "Get the amended po items",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1400,
        320
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "50",
          "name": "Mozart DMS Token"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "let vendorPoDetails = $node[\"Get the vendor po\"].json.data;\nlet poItemDetails = $node[\"Get the po items\"].json.data;\nlet amendedVendorPoDetails = $node[\"Get the amended vendor po\"].json.data;\nlet amendedPoItemDetails = $node[\"Get the amended po items\"].json.data;\nlet latestVendorPo = $node[\"Get the latest vendor po\"].json.data;\nlet newVendorPosArr = [];\nlet payload = $node[\"Webhook\"].json[\"body\"][\"payload\"];\nlet updateDeliveryDate = false;\nlet vedantaPoDeliveryDate = vendorPoDetails[0].po_num.po_deliver_date;\nlet vendorPoDeliveryDate = vendorPoDetails[0].po_deliver_date;\nlet getAllVendorPos = $node[\"Get all vendor pos\"].json.data;\n\n\nif($node[\"Webhook\"].json[\"body\"][\"payload\"][\"vendor\"]){\n  let poItems = [];\n  amendedPoItemDetails.forEach(function(item,index){\n    poItems.push({\n      //id:\n    })\n  })\n  newVendorPosArr.push({\n    id:amendedVendorPoDetails[0].id.split(\"-\")[1].includes(\"R\")?parseInt(latestVendorPo[0].id.split(\"-\")[1].split(\"R\")[1])+1:amendedVendorPoDetails+\"R1\",\n    vendor:$node[\"Webhook\"].json[\"body\"][\"payload\"][\"vendor\"],\n    po_num:amendedVendorPoDetails[0].po_num,\n    po_date:vendorPoDetails[0].po_date,\n    po_status:\"draft\",\n\n  })\n}else if(payload[\"po_items\"]){\n  let createdItems = payload[\"po_items\"].create;\n  let updatedItems = payload[\"po_items\"].update;\n  let deletedItems = payload[\"po_items\"][\"delete\"];\n  let checkForVendorUpdate = updatedItems.filter(uItems=>uItems.vendor);\n  let checkForDeliveryUpdate = updatedItems.filter(uItems=>uItems.delivery_date);\n  let checkForPriceChange = updatedItems.filter(uItems=>uItems.unit_price);\n  let checkForTaxChange = updatedItems.filter(uItems=>uItems.tax_percentage);\n\n  if(checkForVendorUpdate.length>0){\n\n  }else if(!checkForVendorUpdate.length>0){\n    if(checkForDeliveryUpdate.length>0){\n      updateDeliveryDate=true;\n      let minVendorPoDate = new Date(\n          Math.min(\n            ...amendedPoItemDetails.map(element => {\n              return new Date(element.delivery_date);\n              }),\n            ),\n          );\n      vendorPoDeliveryDate = new Date(minVendorPoDate).toISOString();\n      let getMatchedVendorPo =getAllVendorPos.findIndex(po=>amendedVendorPoDetails[0].id == po.id);\n      getAllVendorPos[getMatchedVendorPo].po_deliver_date = vendorPoDeliveryDate;\n      let minPoDate = new Date(\n        Math.min(\n          ...getAllVendorPos.map(element => {\n            return new Date(element.po_deliver_date);\n            }),\n          ),\n        );\n      vedantaPoDeliveryDate = new Date(minPoDate).toISOString();\n    }\n  }\n}\n\n\n\nitems[0].json.updateDeliveryDate =updateDeliveryDate;\nitems[0].json.vedantaPoDeliveryDate=vedantaPoDeliveryDate;\nitems[0].json.vendorPoDeliveryDate=vendorPoDeliveryDate;\nreturn items;"
      },
      "name": "Function to amend po",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1780,
        320
      ]
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "={{$node[\"Get url and token\"].json[\"0\"][\"mozart_url\"]}}/items/sdm_vendor_pos?filter={\"po_num\":{\"_eq\":\"{{$node[\"Get the amended vendor po\"].json[\"data\"][0][\"po_num\"]}}\"}}&sort=-date_created&limit=1",
        "options": {}
      },
      "name": "Get the latest vendor po",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1580,
        320
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "50",
          "name": "Mozart DMS Token"
        }
      }
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "={{$node[\"Get url and token\"].json[\"0\"][\"mozart_url\"]}}/items/sdm_vendor_pos?filter={\"po_num\":{\"_eq\":\"{{$node[\"Get the vendor po\"].json[\"data\"][0][\"po_num\"][\"id\"]}}\"}}",
        "options": {}
      },
      "name": "Get all vendor pos",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1040,
        320
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "50",
          "name": "Mozart DMS Token"
        }
      }
    },
    {
      "parameters": {},
      "name": "Check for delivery update",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        2000,
        320
      ]
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "requestMethod": "PATCH",
        "url": "={{$node[\"Get url and token\"].json[\"0\"][\"mozart_url\"]}}/items/sdm_vendor_pos/{{$node[\"Webhook\"].json[\"body\"][\"keys\"][0]}}",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "po_deliver_date",
              "value": "={{$node[\"Function to amend po\"].json[\"vendorPoDeliveryDate\"]}}"
            }
          ]
        }
      },
      "name": "Udpate delivery dates",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        2080,
        180
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "50",
          "name": "Mozart DMS Token"
        }
      }
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "requestMethod": "PATCH",
        "url": "={{$node[\"Get url and token\"].json[\"0\"][\"mozart_url\"]}}/items/sdm_pos/{{$node[\"Get the amended vendor po\"].json[\"data\"][0][\"po_num\"]}}",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "po_deliver_date",
              "value": "={{$node[\"Function to amend po\"].json[\"vedantaPoDeliveryDate\"]}}"
            }
          ]
        }
      },
      "name": "Udpate vedanta delivery date",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        2280,
        180
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "50",
          "name": "Mozart DMS Token"
        }
      }
    }
  ],
  "settings": {},
  "staticData": null,
  "tags": [],
  "updatedAt": "2024-01-10T11:50:02.189Z"
}