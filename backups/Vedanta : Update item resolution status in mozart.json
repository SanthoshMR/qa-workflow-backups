{
  "active": true,
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Get url and token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get url and token": {
      "main": [
        [
          {
            "node": "Get the resolution from vpanel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get the resolution from vpanel": {
      "main": [
        [
          {
            "node": "Get the latest DC",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set": {
      "main": [
        [
          {
            "node": "Function",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function": {
      "main": [
        [
          {
            "node": "Update resolution status in mozart",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update resolution status in mozart": {
      "main": [
        [
          {
            "node": "Postgres",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres": {
      "main": [
        [
          {
            "node": "Update resolution in shipment item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update resolution in shipment item": {
      "main": [
        [
          {
            "node": "IF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF": {
      "main": [
        [
          {
            "node": "Get the close transaction file from vpanel",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "NoOp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get the close transaction file from vpanel": {
      "main": [
        [
          {
            "node": "Update credit note in mozart",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update credit note in mozart": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "update close transaction in mozart",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get the latest DC": {
      "main": [
        [
          {
            "node": "Set",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2023-09-11T07:22:26.693Z",
  "id": "355",
  "name": "Vedanta : Update item resolution status in mozart",
  "nodes": [
    {
      "parameters": {},
      "name": "Start",
      "type": "n8n-nodes-base.start",
      "typeVersion": 1,
      "position": [
        240,
        300
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "update-resolution-item-status",
        "options": {}
      },
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        460,
        300
      ],
      "webhookId": "4b53ab75-eef9-401f-9c31-f6fcf31d8cda"
    },
    {
      "parameters": {
        "authentication": "basicAuth",
        "requestMethod": "POST",
        "url": "=https://qan8n.shakedeal.com/webhook/get-url",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "client",
              "value": "=vedanta"
            },
            {
              "name": "env",
              "value": "=qa"
            }
          ]
        }
      },
      "name": "Get url and token",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        700,
        300
      ],
      "credentials": {
        "httpBasicAuth": {
          "id": "2",
          "name": "SD Basic Auth"
        }
      }
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "={{$node[\"Get url and token\"].json[\"0\"][\"vendor_panel_url\"]}}/items/sdv_grn_resolutions/{{$node[\"Webhook\"].json[\"body\"][\"payload\"][\"resolution_id\"]}}?fields=*,shipment.*,resolution_items.*,resolution_items.shipment_item.*,resolution_items.shipment_item.sdv_vendor_pos_sdv_products_id.*",
        "options": {}
      },
      "name": "Get the resolution from vpanel",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        920,
        300
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "51",
          "name": "VendorPanel DMS Token"
        }
      }
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "value": "={{$node[\"Get the resolution from vpanel\"].json[\"data\"][\"resolution_items\"]}}"
            }
          ]
        },
        "options": {}
      },
      "name": "Set",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        1140,
        300
      ]
    },
    {
      "parameters": {
        "functionCode": "let resolutionItems = $node[\"Get the resolution from vpanel\"].json[\"data\"][\"resolution_items\"];\nlet mozartResolutionId = $node[\"Get the resolution from vpanel\"].json[\"data\"][\"mozart_resolution_id\"];\nlet updateResolutionItemQuery = \"\";\nlet updateShipmentItemQuery = \"\";\nlet isCloseTransaction = false;\nlet updateItemId = 0;\nlet latestDc= $node[\"Get the latest DC\"].json[\"data\"]\n\nresolutionItems.forEach(function(rItem,index){\n  updateResolutionItemQuery=updateResolutionItemQuery+`update sdm_resolution_items set resolution = '${rItem.resolution}' where shipment_item = ${rItem.mozart_item_id} and grn_resolution = ${mozartResolutionId};`+\" \";\n  updateShipmentItemQuery=updateShipmentItemQuery+`update sdm_shipment_items set resolution = '${rItem.resolution}' where id = ${rItem.mozart_item_id};`+\" \";\n  if(rItem.resolution == \"close_transaction\"){\n    isCloseTransaction =  true;\n    updateItemId = rItem.mozart_item_id\n  }\n})\n\nlet shipmentItems = [];\nlet grossInvoiceValue = 0;\nlet netInvoiceValue = 0;\nlet sameInvoiceItems = resolutionItems.filter(resolutionItem=>resolutionItem.resolution == \"same_invoice\");\nsameInvoiceItems.forEach(function(invoiceItem,index){\n  shipmentItems.push({\n    sdv_vendor_pos_sdv_products_id:invoiceItem.shipment_item.sdv_vendor_pos_sdv_products_id.id,\n    shipment_qty:invoiceItem.rejected_qty\n  })\n\n  let itemNetValue = invoiceItem.shipment_item.sdv_vendor_pos_sdv_products_id.rate * invoiceItem.rejected_qty;\n  netInvoiceValue+=itemNetValue;\n  let itemGrossValue = itemNetValue+(itemNetValue*invoiceItem.shipment_item.sdv_vendor_pos_sdv_products_id.tax_percentage)/100;\n  grossInvoiceValue+=itemGrossValue\n\n})\nlet latestInvoiceNumber = `${latestDc[0].invoice_number.split(\"-\")[0]}-${parseInt(latestDc[0].invoice_number.split(\"-\")[1])+1}`\nlet dcShipment = {\n  vendor_po_number:resolutionItems[0].shipment_item.sdv_vendor_pos_sdv_products_id.sdv_vendor_pos_id,\n  invoice_number:latestInvoiceNumber,\n  invoice_date:new Date.toISOString(),\n  invoice_value:grossInvoiceValue,\n  net_invoice_value:netInvoiceValue,\n  shipment_items:shipmentItems\n}\n\nitems[0].json.updateResolutionItemQuery = updateResolutionItemQuery.trim();\nitems[0].json.updateShipmentItemQuery= updateShipmentItemQuery.trim();\nitems[0].json.isCloseTransaction = isCloseTransaction;\nitems[0].json.update_item_id = updateItemId;\nitems[0].json.dc_shipment = dcShipment;\nreturn items;"
      },
      "name": "Function",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1360,
        300
      ]
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "requestMethod": "PATCH",
        "url": "={{$node[\"Get url and token\"].json[\"0\"][\"mozart_url\"]}}/items/sdm_grn_resolutions/{{$node[\"Get the resolution from vpanel\"].json[\"data\"][\"mozart_resolution_id\"]}}",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "resolution_status",
              "value": "=resolved"
            }
          ]
        }
      },
      "name": "Update resolution status in mozart",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1580,
        300
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "50",
          "name": "Mozart DMS Token"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{$node[\"Function\"].json[\"updateResolutionItemQuery\"]}}",
        "additionalFields": {}
      },
      "name": "Postgres",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        1800,
        300
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "78",
          "name": "Vedanta postgres qa"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{$node[\"Function\"].json[\"updateShipmentItemQuery\"]}}",
        "additionalFields": {}
      },
      "name": "Update resolution in shipment item",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        2020,
        300
      ],
      "executeOnce": false,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "78",
          "name": "Vedanta postgres qa"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": true,
              "value2": "={{$node[\"Function\"].json[\"isCloseTransaction\"]}}"
            }
          ]
        }
      },
      "name": "IF",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        2240,
        300
      ]
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "={{$node[\"Get url and token\"].json[\"0\"][\"vendor_panel_url\"]}}/assets/{{$node[\"Get the resolution from vpanel\"].json[\"data\"][\"credit_note_file\"]}}",
        "responseFormat": "file",
        "options": {}
      },
      "name": "Get the close transaction file from vpanel",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        2380,
        180
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "51",
          "name": "VendorPanel DMS Token"
        }
      }
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "requestMethod": "POST",
        "url": "={{$node[\"Get url and token\"].json[\"0\"][\"mozart_url\"]}}/files",
        "allowUnauthorizedCerts": true,
        "jsonParameters": true,
        "options": {
          "bodyContentType": "multipart-form-data"
        },
        "sendBinaryData": true,
        "binaryPropertyName": "=input_file:data"
      },
      "name": "Update credit note in mozart",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        2600,
        180
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "50",
          "name": "Mozart DMS Token"
        }
      }
    },
    {
      "parameters": {},
      "name": "NoOp",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2440,
        420
      ]
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "requestMethod": "PATCH",
        "url": "={{$node[\"Get url and token\"].json[\"0\"][\"mozart_url\"]}}/items/sdm_grn_resolutions/{{$node[\"Get the resolution from vpanel\"].json[\"data\"][\"mozart_resolution_id\"]}}",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "credit_note_file",
              "value": "={{$node[\"Update credit note in mozart\"].json[\"data\"][\"id\"]}}"
            },
            {
              "name": "credit_note_number",
              "value": "={{$node[\"Get the resolution from vpanel\"].json[\"data\"][\"credit_note_number\"]}}"
            }
          ]
        }
      },
      "name": "HTTP Request",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        2820,
        180
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "50",
          "name": "Mozart DMS Token"
        }
      }
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "requestMethod": "PATCH",
        "url": "={{$node[\"Get url and token\"].json[\"0\"][\"mozart_url\"]}}/items/sdm_shipment_items/{{$node[\"Function\"].json[\"update_item_id\"]}}",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "resolution",
              "value": "=close_transaction"
            }
          ]
        }
      },
      "name": "update close transaction in mozart",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        3040,
        180
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "50",
          "name": "Mozart DMS Token"
        }
      }
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "={{$node[\"Get url and token\"].json[\"0\"][\"vendor_panel_url\"]}}/items/sdm_shipments?filter={\"invoice_number\":{\"_contains\":\"{{$node[\"Get the resolution from vpanel\"].json[\"data\"][\"shipment\"][\"invoice_number\"].spilt(\"-\")[0]}}\"}}&sort=-date_created",
        "options": {}
      },
      "name": "Get the latest DC",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1020,
        0
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "51",
          "name": "VendorPanel DMS Token"
        }
      }
    }
  ],
  "settings": {},
  "staticData": null,
  "tags": [],
  "updatedAt": "2023-11-06T13:42:37.402Z"
}