{
  "active": false,
  "connections": {
    "Start": {
      "main": [
        [
          {
            "node": "Get url and token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get url and token": {
      "main": [
        [
          {
            "node": "Postgres",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres": {
      "main": [
        [
          {
            "node": "Function",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function": {
      "main": [
        [
          {
            "node": "Send Vendor Follow Up",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2022-12-15T09:17:54.370Z",
  "id": "250",
  "name": "Vedanta : Vendor follow up",
  "nodes": [
    {
      "parameters": {},
      "name": "Start",
      "type": "n8n-nodes-base.start",
      "typeVersion": 1,
      "position": [
        240,
        300
      ]
    },
    {
      "parameters": {
        "authentication": "basicAuth",
        "requestMethod": "POST",
        "url": "=https://qan8n.shakedeal.com/webhook/get-url",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "client",
              "value": "=vedanta"
            },
            {
              "name": "env",
              "value": "=qa"
            }
          ]
        }
      },
      "name": "Get url and token",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        520,
        300
      ],
      "credentials": {
        "httpBasicAuth": {
          "id": "2",
          "name": "SD Basic Auth"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=select cpo.delivery_status as deliveryStatus,v.id as email,vpo.id as SDPO,vpo.po_value,i.id,vpo.po_date,oi.quantity as order_quantity,i.product,s.shipment_status,s.invoice_number,p.product_name,i.requested_qty,i.ordered_qty,s.id as sid,s.shipment_status,oi.sdm_po_items_id,vpo.po_status,delivery_date,pl.delivery_address,(delivery_date -now()) as due  from sdm_po_items i\njoin sdm_vendor_pos vpo on vpo.id = i.vendor_po\nand delivery_date < NOW() + INTERVAL '1 Month'\nand vpo.po_status not in('complete','cancelled','payment_pending','draft','open')\nleft join sdm_shipments s on s.vendor_po_num = vpo.id \nleft join sdm_orders o on o.shipment = s.id\nleft join sdm_order_items oi on oi.sdm_orders_id = o.id \nand oi.sdm_po_items_id = i.id\njoin sdm_vendors v on v.id = vpo.vendor\njoin sdm_products p on p.id = i.product\njoin sdm_plants pl on pl.id = i.plant\njoin sdm_pos cpo on cpo.id = i.po\nwhere cpo.delivery_status not in ('closed') and (shipment_status in ('open','awaiting_irn','awaiting_asn') or shipment_status is null)\norder by delivery_date asc\nlimit 30",
        "additionalFields": {}
      },
      "name": "Postgres",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        760,
        280
      ],
      "credentials": {
        "postgres": {
          "id": "78",
          "name": "Vedanta postgres qa"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "let followUpData =[];\nlet vendorFollowUpTable = [];\nlet emailData = []\nlet followUpDataIndex = 0;\nitems.forEach((item,index)=>{\n    let checkRecordExists = followUpData.filter(data=>data.vendor == item.json.email && data.item_code == item.json.product);\n    if(checkRecordExists.length == 0){\n      let sameVendorProduct = items.filter(i=>i.json.product == item.json.product && i.json.email == item.json.email);\n      const qty = sameVendorProduct.reduce(function (result, product) {\n        return result + (product.json.order_quantity?product.json.order_quantity:0);\n      }, 0);\n      let ordered_qty = item.json.ordered_qty?item.json.ordered_qty:0\n      followUpData[followUpDataIndex]={};\n      followUpData[followUpDataIndex].po_item =  item.json.id \n      followUpData[followUpDataIndex].vendor = item.json.email;\n      followUpData[followUpDataIndex].po_date = item.json.po_date.replace(\"T00:00:00.000Z\",\"\").split(\"-\").reverse().join(\"-\");\n      followUpData[followUpDataIndex].po_number = item.json.sdpo;\n      followUpData[followUpDataIndex].item_code = item.json.product;\n      followUpData[followUpDataIndex].material = item.json.product_name;\n      followUpData[followUpDataIndex].qty = item.json.shipment_status?(item.json.requested_qty - ordered_qty) + qty:item.json.requested_qty\n      followUpData[followUpDataIndex].po_value = item.json.po_value;\n      followUpData[followUpDataIndex].delivery_date = item.json.delivery_date.replace(\"T00:00:00.000Z\",\"\").split(\"-\").reverse().join(\"/\");\n      followUpData[followUpDataIndex].delivery_status = item.json.deliverystatus;\n      followUpData[followUpDataIndex].due_days = item.json.due.days?item.json.due.days:0;\n      followUpData[followUpDataIndex].due_hours = item.json.due.hours;\n      followUpData[followUpDataIndex].delivery_address = item.json.delivery_address\n      followUpDataIndex++\n    }\n})\nlet filteredFollowUpData = followUpData.filter(data=>data.qty >0);\nconst groupBy = key => array =>\n  array.reduce((objectsByKeyValue, obj) => {\n    const value = obj[key];\n    objectsByKeyValue[value] = (objectsByKeyValue[value] || []).concat(obj);\n    return objectsByKeyValue;\n  }, {});\nconst groupByBrand = groupBy('vendor');\nconst result = groupByBrand(filteredFollowUpData);\nlet i = 0\nfor (const key in result) {\n    let tableData= \"\";\n    let tableHtml = \"\";\n    let itemsData = result[key];\n    itemsData.forEach(function(item,index){\n      let style = \"\";\n      let diffDays = \"\"\n      if(item.due_days == 0){\n        diffDays = `Due in ${Math.abs(item.due_hours)} hours`\n        style = \"background-color:#D5B567\"\n      }else if(item.due_days < 0 ){\n        let days = item.due_days == -1?2:item.due_days\n        diffDays = `Overdue by ${Math.abs(days)} days`\n        style = \"background-color:#E35169\"\n      }else if(item.due_days<=10&&item.due_days>0 ){\n        let days = item.due_days == 1?2:item.due_days\n        diffDays = `Due in ${days} days`\n        style = \"background-color:#D5B567\"\n      }\n      else {\n        diffDays = `Due in ${item.due_days} days`\n        style = \"background-color:#26C464\"\n      }\n      tableData=tableData+\n      `<tr style=${style}>`+\n      `<td>${index+1}</td>`+\n      `<td>${item[\"po_date\"]}</td>`+\n      `<td>${item[\"po_number\"]}</td>`+\n      `<td>${item[\"item_code\"]}</td>`+\n      `<td>${item[\"material\"]}</td>`+\n      `<td>${item[\"qty\"] }</td>`+\n      `<td>${item[\"po_value\"] }</td>`+\n      `<td>${item[\"delivery_date\"] }</td>`+\n      `<td>${diffDays}</td>`+\n      `<td>${item[\"delivery_address\"]}</td>`+\n      `</tr>`;\n    })\n    tableHtml = tableHtml+ `<table  style=\"color:#fff;width: auto;\">`+\n    `<tr style=\"background-color:#a7d\">`+\n    `<th>SL.No</th>`+\n    `<th>PO Date</th>`+\n    `<th>SDPO No</th>`+\n    `<th>ITEM CODE</th>`+\n    `<th>Material List</th>`+\n    `<th>Qty</th>`+\n    `<th>SDPO Value</th>`+\n    `<th>Item Delivery Date</th>`+\n    `<th>Delivery Status</th>`+\n    `<th>Plant Delivery Address</th>`+\n    `</tr>${tableData}`+\n    `</table>`;\n    vendorFollowUpTable[i] = {};\n    vendorFollowUpTable[i].vendor = key;\n    vendorFollowUpTable[i].tableData = tableData;\n    vendorFollowUpTable[i].tableHtml = tableHtml;\n    \n    emailData.push({\n    json: {\n       vendorFollowUpTable:vendorFollowUpTable[i]\n      }\n    });\n    i++;\n}\n// return [{\n//      json: {\n//          followUpData: followUpData,\n//          result : result,\n//          vendorFollowUpTable:vendorFollowUpTable\n//     }\n// }];\n  //  emailData.push({\n  //   json: [{\n  //      vendorFollowUpTable:vendorFollowUpTable\n  //     }]\n  //   });\n\nreturn emailData;\n\n// items[0].json.followUpDataTest = followUpData;\n// return items;"
      },
      "name": "Function",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1000,
        300
      ]
    },
    {
      "parameters": {
        "fromEmail": "handyalasairam9177@gmail.com",
        "toEmail": "=shakedeal.web@gmail.com",
        "subject": "=Reminder : Delivery status of the POs mentioned in the report || Opcommerce Online Pvt. Ltd.",
        "html": "=<p>Hello sir/maâ€™am ,</p>\n<p>Kindly share the delivery and dispatch details for the following items at the earliest:</p>\n{{$node[\"Function\"].json[\"vendorFollowUpTable\"][\"tableHtml\"]}}\n<p>Request you to expedite the delivery.</p>\n<span style=\"font-size: 12pt;\" class=\"x_751338333size\"><img style=\"cursor: pointer; width: 1.125in;\" src=\"https://sdqa.shakedeal.com/images/logos/2/ShakeDealLogo.png\" height=\"74\" width=\"1.125in\"></span>\n<p>Opcommerce Online Pvt. Ltd.</p>\n<p>DEDICATED PURCHASING PARTNER FOR:</p>\n<span style=\"font-size: 12pt;\" class=\"x_751338333size\"><img style=\"cursor: pointer; width: 1.125in;\" src=\"https://sdqa.shakedeal.com/images/logos/2/ShakeDealLogo.png\" height=\"74\" width=\"1.125in\"></span>",
        "options": {}
      },
      "name": "Send Vendor Follow Up",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 1,
      "position": [
        1200,
        300
      ],
      "credentials": {
        "smtp": {
          "id": "17",
          "name": "smtp(sai)creds"
        }
      }
    }
  ],
  "settings": {
    "saveManualExecutions": true
  },
  "staticData": null,
  "tags": [],
  "updatedAt": "2023-01-11T12:12:57.362Z"
}